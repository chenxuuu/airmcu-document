import{_ as c}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as p,o as l,c as i,a as n,b as s,d as a,w as u,e}from"./app-L4q_l0Kg.js";const r="/assets/ws2812-ds-2JLntmG3.png",k="/assets/QQ20230811140354-QOL147tK.png",d="/assets/ws2812-show-fovyKxJf.gif",m={},v=n("h2",{id:"简介",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#简介","aria-hidden":"true"},"#"),s(" 简介")],-1),b=n("p",null,"本章介绍使用Air001开发板驱动 WS2812 灯。",-1),_={class:"hint-container tip"},h=n("p",{class:"hint-container-title"},"提示",-1),g={href:"http://world-semi.com/ws2812-family/",target:"_blank",rel:"noopener noreferrer"},y=n("br",null,null,-1),f=n("h2",{id:"硬件准备",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#硬件准备","aria-hidden":"true"},"#"),s(" 硬件准备")],-1),w=n("code",null,"Air001",-1),S=n("code",null,"DAPLink调试器",-1),D=n("li",null,[n("p",null,[s("将"),n("code",null,"Air001开发板"),s("的 USB 插入一根数据线，用向灯板提供 5V 电压。")])],-1),L=n("li",null,[n("p",null,[s("将"),n("code",null,"WS2812"),s("LED 模块与"),n("code",null,"Air001开发板"),s("，按如下表格进行相连：")])],-1),x=e('<table><thead><tr><th style="text-align:center;">WS2812 模块</th><th style="text-align:center;">Air001</th></tr></thead><tbody><tr><td style="text-align:center;">GND</td><td style="text-align:center;">GND</td></tr><tr><td style="text-align:center;">VCC</td><td style="text-align:center;">VBUS(5V)</td></tr><tr><td style="text-align:center;">DIN</td><td style="text-align:center;">PA_7</td></tr></tbody></table><div class="hint-container tip"><p class="hint-container-title">提示</p><p>由于 WS2812 的时序要求相对严格，我们将使用 SPI 的 MOSI 引脚（PA_7）对其进行驱动。</p></div><h2 id="软件部分" tabindex="-1"><a class="header-anchor" href="#软件部分" aria-hidden="true">#</a> 软件部分</h2>',3),E=n("code",null,"WS2812",-1),I={href:"https://github.com/452/arduino-ws2812-direct-spi-control",target:"_blank",rel:"noopener noreferrer"},P=e('<details class="hint-container details"><summary>WS2812 的控制时序，此处不作深入讲解</summary><figure><img src="'+r+'" alt="文档时序内容" tabindex="0" loading="lazy"><figcaption>文档时序内容</figcaption></figure></details><p>首先，<strong>为了保证 SPI 频率在 8MHz，我们需要将芯片的主频设置为 16M</strong>，这样只要设置 SPI 二分频即可实现输出为 8MHz。</p><details class="hint-container details"><summary>在Arduino中设置芯片主频</summary><figure><img src="'+k+`" alt="设置芯片主频" tabindex="0" loading="lazy"><figcaption>设置芯片主频</figcaption></figure></details><p>我们在代码开头，引用库与定义需要使用的全局量：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;SPI.h&gt;</span></span>
<span class="token comment">//LED灯的个数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_N</span>   <span class="token expression"><span class="token number">64</span></span></span>
<span class="token comment">//用于存储当前LED灯的状态，默认全为(0,0,0)不亮</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> LED_T<span class="token punctuation">[</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的<code>LED_T</code>用于存储当前的LED灯颜色数据，可以在刷新时一次性将所有状态全部发给<code>WS2812</code>。</p><p>在<code>setup</code>初始化函数中，我们初始化一下<code>SPI</code>，并将灯的状态初始化（全部熄灭）：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//初始化SPI</span>
  SPI<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  SPI<span class="token punctuation">.</span><span class="token function">setBitOrder</span><span class="token punctuation">(</span>MSBFIRST<span class="token punctuation">)</span><span class="token punctuation">;</span>
  SPI<span class="token punctuation">.</span><span class="token function">setDataMode</span><span class="token punctuation">(</span>SPI_MODE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里需要让SPI处于8MHz</span>
  <span class="token comment">// 所以芯片要设置16M，SPI配置为2分频：</span>
  <span class="token comment">// 16/2=8MHz</span>
  SPI<span class="token punctuation">.</span><span class="token function">setClockDivider</span><span class="token punctuation">(</span>SPI_CLOCK_DIV2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//刷新一下所有灯的状态，函数见文档接下来的内容</span>
  <span class="token function">WS2812_refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的重点是<code>SPI.setClockDivider</code>函数，它设置了 SPI 频率在 8MHz。<br><code>SPI.setBitOrder</code>和<code>SPI.setDataMode</code>的配置，也保证了后续模拟时序的正确性。</p><p>接下来是真正模拟<code>WS2812</code>时序的函数，这个函数传入 RGB 值，转换为信号进行发送：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">WS2812_send</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> r<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> g<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bits <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> value <span class="token operator">=</span> <span class="token number">0x00000000</span><span class="token punctuation">;</span>
  value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>bits <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">&amp;</span> <span class="token number">0x800000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      SPI<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">0xF8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
      <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">&quot;nop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">asm</span><span class="token punctuation">(</span><span class="token string">&quot;nop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      SPI<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">0xC0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0</span>
    <span class="token punctuation">}</span>
    value <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bits<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于<code>WS2812</code>灯珠是串在一起进行通信的，当需要控制所有灯珠时，只要将颜色数据一个个发送出去就可以了。<br> 所以<code>WS2812_refresh</code>刷新函数就像下面这样，依次发送颜色数据：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">WS2812_refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> LED_N<span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">WS2812_send</span><span class="token punctuation">(</span>LED_T<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> LED_T<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> LED_T<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">delayMicroseconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后我们在<code>loop</code>函数中，简单写一个按顺序亮灯的小功能：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">//把上一次亮的灯灭了</span>
  LED_T<span class="token punctuation">[</span><span class="token punctuation">(</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  LED_T<span class="token punctuation">[</span><span class="token punctuation">(</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  LED_T<span class="token punctuation">[</span><span class="token punctuation">(</span>count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//点亮这次的这个灯</span>
  <span class="token comment">//来个浅蓝色吧</span>
  <span class="token comment">//亮度低一点，不然刺眼</span>
  LED_T<span class="token punctuation">[</span>count<span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">//R</span>
  LED_T<span class="token punctuation">[</span>count<span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">//G</span>
  LED_T<span class="token punctuation">[</span>count<span class="token operator">%</span>LED_N<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token comment">//B</span>
  <span class="token comment">//刷新所有灯的状态</span>
  <span class="token function">WS2812_refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//延时一小会</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="输出结果" tabindex="-1"><a class="header-anchor" href="#输出结果" aria-hidden="true">#</a> 输出结果</h2><p>可以看到，灯会按顺序闪烁：</p><figure><img src="`+d+'" alt="灯按顺序亮起" tabindex="0" loading="lazy"><figcaption>灯按顺序亮起</figcaption></figure>',18);function W(N,M){const t=p("ExternalLinkIcon"),o=p("RouterLink");return l(),i("div",null,[v,b,n("div",_,[h,n("p",null,[n("a",g,[s("WS2812 是一个三色 LED 驱动芯片"),a(t)]),s("，一般集成在 LED 灯珠中。"),y,s(" 它仅需一个 IO 传输数据，可通过多个 LED 串联传递信号，实现批量控制。")])]),f,n("ul",null,[n("li",null,[n("p",null,[s("按"),a(o,{to:"/tutorial-advanced/Air001_start.html"},{default:u(()=>[s("☁️ Air001开发板入门")]),_:1}),s("，将"),w,s("和"),S,s("使用排针排母连接。")])]),D,L]),x,n("p",null,[s("查阅资料，我们可以得知"),E,s("需要严格的时序，我们将参考"),n("a",I,[s("此处"),a(t)]),s("的代码，使用 SPI 进行驱动。")]),P])}const B=c(m,[["render",W],["__file","ws2812.html.vue"]]);export{B as default};
