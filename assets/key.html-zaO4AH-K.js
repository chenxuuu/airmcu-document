import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as a,e}from"./app-L4q_l0Kg.js";const p={},t=e(`<h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>本文将介绍使用 Air001 开发板按键打印按键状态。</p><h2 id="硬件准备" tabindex="-1"><a class="header-anchor" href="#硬件准备" aria-hidden="true">#</a> 硬件准备</h2><p>Air001开发板一块。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在 Air001 开发板上，<code>BOOT</code>按键可作为通用按键使用，GPIO 编号为<code>PB6</code>，具体可参考 Air001 硬件手册。</p></div><h2 id="软件部分" tabindex="-1"><a class="header-anchor" href="#软件部分" aria-hidden="true">#</a> 软件部分</h2><p>首先，在代码的开头定义一下全局变量：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">int</span> ButtonState <span class="token operator">=</span> LOW<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Button</span> <span class="token expression">PB_6</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>定义<code>ButtonState</code>变量，用于存储上一次的按键状态。</li><li>将<code>Button</code>的值定义为<code>PB_6</code>，<code>BOOT</code>按键所属的 GPIO。</li></ul><p>接着，在<code>setup()</code>函数中，添加如下代码：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>Button<span class="token punctuation">,</span> INPUT_PULLDOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>初始化串口为<code>9600</code>波特率，用于打印按键状态。</li><li>使用<code>pinMode</code>函数初始化<code>PB6</code>这个GPIO，并且设置为<code>INPUT_PULLDOWN</code>下拉输入模式。</li></ul><p>最后，我们在<code>loop()</code>函数中添加剩下的代码，轮询当前 GPIO 的状态：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token function">digitalRead</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ButtonState<span class="token operator">==</span>state<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> LOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key up&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key pressed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ButtonState <span class="token operator">=</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>我们首先获取这一次的按键电平状态，存入<code>state</code>变量中。</li><li>接着对比这一次的电平是否变化，如果没变化，退出这次检测。</li><li>如果有变化，我们打印一下当前按钮的电平状态，这里使用了<code>三元运算符</code>。</li><li>最后将当前的电平状态存入<code>ButtonState</code>，提供给下一次读取使用。</li></ul><h2 id="输出结果" tabindex="-1"><a class="header-anchor" href="#输出结果" aria-hidden="true">#</a> 输出结果</h2><p>可以在串口监视器中看到：</p><ul><li>当按下按键时，打印<code>key pressed</code>。</li><li>松开时打印<code>key up</code>。</li></ul><div class="language-log line-numbers-mode" data-ext="log"><pre class="language-log"><code>key pressed
key up
key pressed
key up
key pressed
key up
key pressed
key up
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>由于使用了<code>BOOT</code>按键，有概率会影响到自动进入<code>BOOT</code>模式的逻辑。<br> 如若无法进入<code>BOOT</code>模式导致无法烧录，可尝试下面的步骤进行烧录：</p><ul><li>断开 USB 的连接</li><li>按住<code>BOOT</code>按键，不要松开</li><li>插入 USB</li><li>松开<code>BOOT</code>按键</li><li>点击电脑上的烧录按键，开始烧录</li></ul></div><h2 id="进一步优化" tabindex="-1"><a class="header-anchor" href="#进一步优化" aria-hidden="true">#</a> 进一步优化</h2><p>我们会发现，<code>loop()</code>函数中只进行了轮询按键的判断，如果这个函数中添加了其他耗时的操作（比如进行了<code>delay</code>操作），那么按键打印将变得不够及时。</p><p>我们可以使用<code>GPIO 中断</code>来摆脱这种轮询逻辑造成的问题。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>中断</code>就是 CPU 在运行过程中上报的一种<code>异常</code>（只是叫做<code>异常</code>，不一定真的运行异常），它可以打断当前代码的运行，优先执行<code>中断</code>的操作。<br> 当<code>中断</code>处理完后，再继续运行当前代码。<br> 这里的<code>GPIO 中断</code>就是当 GPIO 的状态符合某种条件时，会触发的<code>中断</code>。</p></div><p>首先，在代码的开头定义一下全局变量：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Button</span> <span class="token expression">PB_6</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>将<code>Button</code>的值定义为<code>PB_6</code>，<code>BOOT</code>按键所属的 GPIO。</li></ul><p>接着，新建一个<code>中断回调函数</code>，该函数用于触发中断后，进行调用</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">digitalRead</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token operator">==</span> LOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key up&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key pressed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>当触发<code>onChange</code>函数后，获取一下当前的<code>GPIO</code>状态，用来判断时按下还是松开</li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>中断回调函数</code>是这个<code>中断</code>被触发后会被调用的函数。当这个函数运行完毕后，其他代码会继续执行。</p></div><p>在<code>setup()</code>函数中，添加如下代码：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//打开串口</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>Button<span class="token punctuation">,</span> INPUT_PULLDOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置管脚为输入</span>
  <span class="token function">attachInterrupt</span><span class="token punctuation">(</span><span class="token function">digitalPinToInterrupt</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span><span class="token punctuation">,</span> onChange<span class="token punctuation">,</span> CHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
   LOW 当引脚为低电平时，触发中断
   CHANGE 当引脚电平发生改变时，触发中断
   RISING 当引脚由低电平变为高电平时，触发中断
   FALLING 当引脚由高电平变为低电平时，触发中断
   */</span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>PB_1<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>初始化串口为<code>9600</code>波特率，用于打印按键状态。</li><li>使用<code>attachInterrupt</code>函数初始化一个中断事件，编号可以由<code>digitalPinToInterrupt</code>函数获取，触发标志设置为<code>CHANGE</code>。</li><li>我们使用<code>pinMode</code>函数初始化<code>PB1</code>，并且设置为<code>OUTPUT</code>输出模式，用来闪灯。</li></ul><p>最后我们可以在我们在<code>loop()</code>函数中添加剩下的代码，为了演示不影响按键响应，我们加一个闪灯的功能代码：</p><div class="language-cpp line-numbers-mode" data-ext="cpp"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>PB_1<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>PB_1<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当使用中断方式编写代码时，<code>loop()</code>函数中的延时将不会对按键状态变化时的相应造成影响。</p><h2 id="优化后的结果" tabindex="-1"><a class="header-anchor" href="#优化后的结果" aria-hidden="true">#</a> 优化后的结果</h2><p>我们可以看到开发板上的 LED 灯正常闪烁，并且串口监视器中的按键事件打印也很及时。</p>`,39),c=[t];function o(i,l){return s(),a("div",null,c)}const r=n(p,[["render",o],["__file","key.html.vue"]]);export{r as default};
